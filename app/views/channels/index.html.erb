<head>
  <!-- bootstrap-add-clear -->
  <%= javascript_include_tag "bootstrap-add-clear/bootstrap-add-clear.min.js" %>
  
  <%= javascript_include_tag "readmore-js/readmore.min.js" %>
  
  <!-- Quill - CDN - -->
  <%= javascript_include_tag "quill/quill.js" %>
  <%= stylesheet_link_tag 'quill/quill.snow', media: 'all', 'data-turbolinks-track': 'reload' %>
  
  <%#= javascript_pack_tag 'index.js' %>
  <%= javascript_include_tag "crop_image.js" %>
</head>
<header>
  <!-- サイドメニュー -->
  <div class="menu-container">
    <div id="mySidenav" class="sidenav">
      <div class="sidenav-margin-top">
        <button type="button" class="closebtn" onclick="closeNav()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M5.72 5.72a.75.75 0 011.06 0L12 10.94l5.22-5.22a.75.75 0 111.06 1.06L13.06 12l5.22 5.22a.75.75 0 11-1.06 1.06L12 13.06l-5.22 5.22a.75.75 0 01-1.06-1.06L10.94 12 5.72 6.78a.75.75 0 010-1.06z"></path></svg>
        </button>
      </div>
      <div id="menu-contents">
        <div class="user-information">
          <span class="login-user">
            <div class="current_user-thumbnail">
              <% if @user.images.present? %>
                <%= image_tag @user.images.url, class: 'user-profile-thumbnail' %>
              <% else %>
                <i class="far fa-user-circle"></i>
              <% end %>
            </div>
            <span class="user-name">
              <%= @user.accountName %>
            </span>
          </span>
          <span class="user-edit">
            <span class="btn user-edit-icon" data-toggle="modal" data-target=".user-edit-Modal">
              <svg width="2em" height="2em" viewBox="0 0 16 16" class="bi bi-pencil-square" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456l-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/>
              </svg>
            </span>
          </span>
          
          <div class="modal user-edit-Modal" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true">
            <%= render partial: "users/user_edit_modal" %>
          </div>
        </div>
        <hr class="hr" color="#242424">
        
        <a class="communities-participated"><i class="fas fa-users"></i> 参加コミュニティー</a>
        <% current_user.communities.each do |c| %>
          <div class="dropdown-btn">
            <span class="community-names">
              <%= icon('fas', 'caret-down') %> <%= c.communityName %>あああああああああ
            </span>
            <%= link_to communities_community_edit_path(id: c.id), class: "community-edit", id: "tcomment-btn-a#{ c.id }", remote: true do %>
              <span class="btn community-edit-icon" data-toggle="modal" data-target="#community-edit-Modal<%= c.id %>">
                <svg width="2em" height="2em" viewBox="0 0 16 16" class="bi bi-pencil-square" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                  <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456l-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                  <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/>
                </svg>
              </span>
            <% end %>
            
            <div class="modal community-edit-Modal" id="community-edit-Modal<%= c.id %>" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true">
              <%#= render partial: "community_edit_modal" %>
            </div>
          </div>
          <div class="dropdown-container">
            <a class="deep-dropdown-btn">
              <%= icon('fas', 'caret-down') %> チャンネル
              <%#=span class="new-channel-btn">
                <%= new_channel_url >
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" class="octicon oct-circle-plus"><path d="M12.75 7.75a.75.75 0 00-1.5 0v3.5h-3.5a.75.75 0 000 1.5h3.5v3.5a.75.75 0 001.5 0v-3.5h3.5a.75.75 0 000-1.5h-3.5v-3.5z"></path><path fill-rule="evenodd" d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zM2.5 12a9.5 9.5 0 1119 0 9.5 9.5 0 01-19 0z"></path></svg>
              </span%>
            </a>
            <div class="deep-dropdown-container">
              <% c.channels.each do |channel| %>
                <%= link_to channels_channel_change_path(id: channel.id), class: 'channel-names', remote: true do %>
                  <span class="color-icons">
                    <span class="rgbs"><%= channel.color %></span>
                  </span>
                  <%= channel.channelName %>
                <% end %>
              <% end %>
              <%= link_to new_channel_path(community_id: c.id), class: 'new-channel-btn' do %>
                <%= icon('fas', 'plus') %>
                チャンネル作成
              <% end %>
            </div>
            <%= link_to events_path(id: c.id), class: 'calendar-btn' do %>
              <%= icon('far', 'calendar-alt') %> カレンダー
            <% end %>
          </div>
        <% end %>
        <hr class="hr" color="#242424">
        <%= link_to logout_path, :method => :delete, class: "logout-btn" do %>
          <%= icon('fas', 'sign-out-alt') %> ログアウト
        <% end %>
      </div>
    </div>
  </div>
</header>
<div class="main-wrapper">
  <!-- サイドオープン時.main-wrapperを覆う -->
  <div class="overlay_container"></div>
  
  <!-- メニューバー -->
  <div id="navbar">
    <div class="floatleft">
      <button type="button" class="menu-trigger" id="sideMenuBtn" onclick="openNav()">
        <%= icon('fas', 'bars fa-3x') %>
      </button>
      <span id="cicon">
        <span id="rgb"></span>
      </span>
      <a class="text-black channel-name">
        <%= @channel.channelName %>
      </a>
      <a class="new-thread-or-event">
        
      </a>
      <%#= link_to new_event_path, class: 'new-channel-btn' do %>
        <%#= icon('fas', 'plus') %>
      <%# end %>
    </div>
    <div class="floatright">
      <button type="button" class="setting-btn">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M16 12a4 4 0 11-8 0 4 4 0 018 0zm-1.5 0a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path><path fill-rule="evenodd" d="M12 1c-.268 0-.534.01-.797.028-.763.055-1.345.617-1.512 1.304l-.352 1.45c-.02.078-.09.172-.225.22a8.45 8.45 0 00-.728.303c-.13.06-.246.044-.315.002l-1.274-.776c-.604-.368-1.412-.354-1.99.147-.403.348-.78.726-1.129 1.128-.5.579-.515 1.387-.147 1.99l.776 1.275c.042.069.059.185-.002.315-.112.237-.213.48-.302.728-.05.135-.143.206-.221.225l-1.45.352c-.687.167-1.249.749-1.304 1.512a11.149 11.149 0 000 1.594c.055.763.617 1.345 1.304 1.512l1.45.352c.078.02.172.09.22.225.09.248.191.491.303.729.06.129.044.245.002.314l-.776 1.274c-.368.604-.354 1.412.147 1.99.348.403.726.78 1.128 1.129.579.5 1.387.515 1.99.147l1.275-.776c.069-.042.185-.059.315.002.237.112.48.213.728.302.135.05.206.143.225.221l.352 1.45c.167.687.749 1.249 1.512 1.303a11.125 11.125 0 001.594 0c.763-.054 1.345-.616 1.512-1.303l.352-1.45c.02-.078.09-.172.225-.22.248-.09.491-.191.729-.303.129-.06.245-.044.314-.002l1.274.776c.604.368 1.412.354 1.99-.147.403-.348.78-.726 1.129-1.128.5-.579.515-1.387.147-1.99l-.776-1.275c-.042-.069-.059-.185.002-.315.112-.237.213-.48.302-.728.05-.135.143-.206.221-.225l1.45-.352c.687-.167 1.249-.749 1.303-1.512a11.125 11.125 0 000-1.594c-.054-.763-.616-1.345-1.303-1.512l-1.45-.352c-.078-.02-.172-.09-.22-.225a8.469 8.469 0 00-.303-.728c-.06-.13-.044-.246-.002-.315l.776-1.274c.368-.604.354-1.412-.147-1.99-.348-.403-.726-.78-1.128-1.129-.579-.5-1.387-.515-1.99-.147l-1.275.776c-.069.042-.185.059-.315-.002a8.465 8.465 0 00-.728-.302c-.135-.05-.206-.143-.225-.221l-.352-1.45c-.167-.687-.749-1.249-1.512-1.304A11.149 11.149 0 0012 1zm-.69 1.525a9.648 9.648 0 011.38 0c.055.004.135.05.162.16l.351 1.45c.153.628.626 1.08 1.173 1.278.205.074.405.157.6.249a1.832 1.832 0 001.733-.074l1.275-.776c.097-.06.186-.036.228 0 .348.302.674.628.976.976.036.042.06.13 0 .228l-.776 1.274a1.832 1.832 0 00-.074 1.734c.092.195.175.395.248.6.198.547.652 1.02 1.278 1.172l1.45.353c.111.026.157.106.161.161a9.653 9.653 0 010 1.38c-.004.055-.05.135-.16.162l-1.45.351a1.833 1.833 0 00-1.278 1.173 6.926 6.926 0 01-.25.6 1.832 1.832 0 00.075 1.733l.776 1.275c.06.097.036.186 0 .228a9.555 9.555 0 01-.976.976c-.042.036-.13.06-.228 0l-1.275-.776a1.832 1.832 0 00-1.733-.074 6.926 6.926 0 01-.6.248 1.833 1.833 0 00-1.172 1.278l-.353 1.45c-.026.111-.106.157-.161.161a9.653 9.653 0 01-1.38 0c-.055-.004-.135-.05-.162-.16l-.351-1.45a1.833 1.833 0 00-1.173-1.278 6.928 6.928 0 01-.6-.25 1.832 1.832 0 00-1.734.075l-1.274.776c-.097.06-.186.036-.228 0a9.56 9.56 0 01-.976-.976c-.036-.042-.06-.13 0-.228l.776-1.275a1.832 1.832 0 00.074-1.733 6.948 6.948 0 01-.249-.6 1.833 1.833 0 00-1.277-1.172l-1.45-.353c-.111-.026-.157-.106-.161-.161a9.648 9.648 0 010-1.38c.004-.055.05-.135.16-.162l1.45-.351a1.833 1.833 0 001.278-1.173 6.95 6.95 0 01.249-.6 1.832 1.832 0 00-.074-1.734l-.776-1.274c-.06-.097-.036-.186 0-.228.302-.348.628-.674.976-.976.042-.036.13-.06.228 0l1.274.776a1.832 1.832 0 001.734.074 6.95 6.95 0 01.6-.249 1.833 1.833 0 001.172-1.277l.353-1.45c.026-.111.106-.157.161-.161z"></path></svg>
      </button>
    </div>
  </div>
  
  <div id="main" class="main-container">
    <div class="thread-container" id="thread-container">
      <%= render @gthreads %>
    </div>
    <div id="mask" class="mask-hidden"></div>
    <button class="btn new_thread-btn">
      <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-card-text" viewBox="0 0 16 16">
        <path fill-rule="evenodd" d="M14.5 3h-13a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h13a.5.5 0 0 0 .5-.5v-9a.5.5 0 0 0-.5-.5zm-13-1A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h13a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-13z"/>
        <path fill-rule="evenodd" d="M3 5.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM3 8a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 3 8zm0 2.5a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5z"/>
      </svg>
    </button>
  </div>
  
  <div class="footer_container">
    <div class="offset-xl-2 offset-lg-2 offset-md-2 offset-1 col-xl-8 col-lg-8 col-md-8 col-10">
      <%= form_with model: @gthread, html: { autocapitalize: "off", autocorrect: "off" }, local: false do |f| %>
        <div class="relative-container">
          <div class="thread-new-container">
            <%= f.hidden_field :channel_id, value: 1 %>
            <div class="form-group">
              <%= f.text_field :title, class: "form-control form-control-lg", id: "thread-new-title", placeholder: "スレッドのタイトル" %>
            </div>
            <div class="form-group">
              <%#= f.text_field :image, type: "search", class: "form-control, placeholder: "YYYY年MM月DD日(d) HH:MM" %>
            </div>
            <div class="form-group" id="text_area">
              <%= f.text_area :description, class: "form-control quill_container", id: "description", placeholder: "スレッドの本文" %>
            </div>
          </div>
          <div class="file-submit-box">
            <%= f.button type: "submit", class: "btn btn-block thread-create-btn" do %>
              <i class="fas fa-paper-plane"></i>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>
<%= javascript_include_tag "mains.js" %>
<%= javascript_include_tag "gthread_destroy.js" %>
<%= javascript_include_tag "mains_resize.js" %>
<script>
  var defaults = {
    theme: 'snow',
    modules: {
      toolbar: [
        //[{ 'header': [1, 2, 3, false] }],
        [{ 'size': ['small', false, 'large'] }],
        ['bold', 'italic', 'underline', 'strike'],
        [{ 'color': [] }, { 'background': [] }],
        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
        [{ 'indent': '-1'}, { 'indent': '+1' }],
        ['blockquote', 'code', 'link']
      ]
    }
  };
  
  Quilljs.setDefaults(defaults)

  // When the user scrolls the page, execute myFunction
  //window.onscroll = function() {stickyFunction()};
  
  //var navbar = document.getElementById("navbar");
  // Get the offset position of the navbar
  //var sticky = navbar.offsetTop;
  
  // Add the sticky class to the navbar when you reach its scroll position. Remove "sticky" when you leave the scroll position
  //function stickyFunction() {
  //  if (window.pageYOffset >= sticky) {
  //    navbar.classList.add("sticky")
  //  } else {
  //    navbar.classList.remove("sticky");
  //  }
  //}

$(function() {
  // サイドメニュー
  var $body = $('.overlay_container');
  
  $('#sideMenuBtn').on('click', function () {
    $body.toggleClass('overlay');
  });
  
  $('.overlay_container, .closebtn, .channel-names').on('click', function () {
    closeNav();
    $body.removeClass('overlay');
  });
  
  // サイドメニュー ドロップダウンリスト
  $('.community-names').on('click', function(){
    $(this).toggleClass('dropdown_toggle');//.children('.dropdown-container').slideToggle(200);
  });
	$('.deep-dropdown-btn').on('click', function(){
		$(this).toggleClass('dropdown_toggle');//.children('.deep-dropdown-container').slideToggle(200);
	});
	
	// サイドメニュー ユーザー/コミュニティ編集モーダル 
	$('.user-edit, .community-edit').on('click', function () {
    closeNav();
    $body.removeClass('overlay');
  });
  
	$('.user-edit-Modal, .community-edit-Modal')
  	.on('show.bs.modal', function() {
      $('body').addClass('modal-opacity8');
    })
    .on('hidden.bs.modal', function() {
      $('body').removeClass('modal-opacity8');
    })
	
	// 画面読み込み時、最下部表示
	//var main_container = document.getElementById('main');
    //main_container.scrollTop = main_container.scrollHeight;
	
	//スレッドにリアクションしたユーザー bootstrap ツールチップ初期化
  //$('[data-toggle="tooltip"]').tooltip({ 
  //  delay: { "show":400, "hide":50 },
  //  html: true,
  //  template: '<div class="treaction-tooltip" role="tooltip"><div class="tooltip-inner"></div></div>'
  //})
  
  // bootstrao-add-clear
  $('#thread-new-title').addClear({
    symbolClass: 'far fa-times-circle',
    color: '#7d7d7d'
  });

  // readmore.js
  $('.thread-description').readmore({
    moreLink: '<div class="btn btn-link readmore">続きを見る<div class="readmore-icon"><i class="fas fa-chevron-down"></i></div></div>',
    lessLink: '<a class="readless">閉じる</a>',
    speed: 10,
    collapsedHeight: 200,
    heightMargin: 40,
    embedCSS: false
  });
  
  // スレッド作成 アコーディオン
  var btnOpen = '.new_thread-btn',
      sld = '.footer_container',
      current_scrollY;
 
  $(btnOpen).on('click',function(e) {
    if ($(sld).css('display') == 'none') {
      $(sld).slideDown();
    }
    $body.toggleClass('overlay');
  });
 
  $(document).on('click',function(e) {
    if ($(sld).css('display') == 'block'){
      if ((!$(e.target).closest(sld).length) && (!$(e.target).closest(btnOpen).length)) {
        $(sld).slideUp();
      }
    }
  });
  
  // スレッド作成フォーム 未入力の場合送信ボタン使用不可 // 未完成
  var submit_btn = $('.thread-create-btn');
  var text_field = $('#ql-editor');
  var text_fields = document.getElementById('ql-editor');
  var text_field_p = $('#ql-editor p');
  var text_field_br = $('#ql-editor > p > br');
  var br1 = $('#ql-editor > p > br')[0];
  
  //var ql_blank = text_fields.classList.contains('ql-blank');
  
  submit_btn.prop('disabled', true);
    
  text_field.on('input keydown', function(e){
    var text_count = text_field_p.html().length;
    //var text_val = ;
    if (text_field_p.html() !== "<br>" && text_field_br.length <= 1 && !text_field_p.html().match(/\S/g) == "") {
      submit_btn.prop('disabled', false);
    } else {
      submit_btn.prop('disabled', true);
    }
    /*if (ql_blank == true) {
      submit_btn.prop('disabled', true);
    } else if (text_field_p.html() !== "<br>") {
      submit_btn.prop('disabled', false);
    }*/
    
    //if (text_count >= 1 && text_field_p.html() !== "<br>" && text_field_br.length >= 1 && !text_field_p.html().match(/\S/g) == "") {
    //  submit_btn.prop('disabled', false);
    //} else {
    //  submit_btn.prop('disabled', true);
    //}
  });
  
  /*let mutationObserver = new MutationObserver(function() {
    if (text_field_p.html() !== "<br>" && text_field_p.html().match(/\S/g) != "") {
      submit_btn.prop('disabled', false);
    } else {
      submit_btn.prop('disabled', true);
    }
  });
  
  mutationObserver.observe(
    document.getElementById('ql-editor'),
    {
      //attributes: true,
      attributeFilter: ['class']
    }
  );*/
  
  $('.thread-create-btn').on('click', function() {
    $(sld).slideUp();
    $body.removeClass('overlay');
  });
});

// 一定期間操作がなかった場合リロード
$(function() {
  var toHome = function() {
    location.href = "/gthreads";
  };
  var timerMs = 60 * 60 * 1000;
  var timerId = setTimeout(toHome, timerMs);

  $('body').on('click keypress mousemove mousedown', function() {
    clearTimeout(timerId);
    timerId = setTimeout(toHome, timerMs);
  });
});

//setTimeout(refresh, 10000);

$(window).load(function(){
  //var main_container = document.getElementById('main');
  //main_container.scrollBottom = 200;
  const threadDescriptionFormClass = document.getElementById('description');
  threadDescriptionFormClass.setAttribute('id', 'ql-editor');
});
$(function(){
    //const rgb = $("#colorswitch [id *= 'rgb']").text();
    //const rgb_id = 'rgb_';
    
    //var rgb_id = document.querySelectorAll("[id *= 'rgb']");
    //selectObj = document.getElementsByTagName('span');
  	//matchObj= new RegExp(rgb_id);
  	
  	//for ( i = 0; i < rgb_id.length; i++ ) {
  	  //const id_match = selectObj[i].id.match(matchObj);
  	  //const text = id_match.text();
  	  /*rgb_id.forEach(function (value) {
  	    if (value.innerHTML == "rgb(0, 191, 255)") {
			$('.color-icon').css({'background-color': 'deepskyblue'});
			alert("oh!");
		} else if (value.innerHTML == "rgb(173, 255, 47)") {
		  alert("ihi!");
		  $('.color-icon').css({'background-color': 'greenyellow'});
		} 
  	  });
  		
  	//}*/
	
});

// cropper.js
$(function () {
  let $image = $('#imageModal'),
    $img_field = $('#user_image'),
    $croppedImage = $('#croppedImage'),
    $cropModal = $('#cropModal'),
    $beforeUpload = $('#beforeUpload'),
    $button = $('#btn-save'),
    $dataX = $('#dataX'),
    $dataY = $('#dataY'),
    $dataWidth = $('#dataWidth'),
    $dataHeight = $('#dataHeight');

  let options = {
    dragmode: 'crop',
    aspectRatio: 1/1,
    restore: false,
    guides: false,
    center: false,
    highlight: true,
    cropBoxMovable: true,
    cropBoxResizable: true,
    modal: true,
    crop: (e) => {
      $dataX.val(Math.round(e.detail.x));
      $dataY.val(Math.round(e.detail.y));
      $dataWidth.val(Math.round(e.detail.width));
      $dataHeight.val(Math.round(e.detail.height));
    }
  };

  // when file upload
  
  // onclick save button
  $button.click(() => {
    imgCropping();
  });

  // modalを閉じたとき、cropper要素を初期化
  $cropModal.on('hidden.bs.modal',function() {
    $image.cropper('destroy').removeAttr('src');
    let $cropperContainer = $('.cropper-container');
    $cropperContainer.remove();
  });

  function imgCropping() {
    if (!croppable) {
      alert('トリミングする画像が用意されていません')
      return false;
    }
    $beforeUpload.hide();
    let croppedData = $image.cropper('getCroppedCanvas').toDataURL();
    $croppedImage.attr('src', croppedData);
    $cropModal.modal('hide');
  }
});

</script>