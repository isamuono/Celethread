var thread_container = document.getElementById('thread-container');
var messageHeight = thread_container.scrollHeight;

thread_container.insertAdjacentHTML('afterbegin', "<%= escape_javascript(render @gthreads) %>");

var newMessageHeight = thread_container.scrollHeight;
main_container.scrollBy(0, newMessageHeight - messageHeight);
// メッセージが存在するときだけ，更に読み込み可能とする
//    ⇨ 一度読み込み不可となった場合、切り替えたチャンネル先でも追加読み込み不可となってしまうため廃止
<%# if @gthreads.present? %><%# if @channel.gthreads.present? %>
  window.showAdditionally = true;
<%# end %>

<% @gthreads.each do |gthread| %>
  // 投稿者のユーザー簡易情報
  tippy('.thread-author-thumbnail<%= gthread.id %>', {
    content: `<div class="tippy-user-container">
                <div class="tippy-userbox-top">
                  <div class="tippy-user-thumbnail">
                    <% if gthread.user.images.present? %>
                      <%= image_tag gthread.user.images.url, class: 'user-profile-thumbnail', loading: "lazy" %>
                    <% else %>
                      <i class="far fa-user-circle"></i>
                    <% end %>
                  </div>
                  <div class="tippy-user-accountName">
                    <%= gthread.user.accountName %>
                  </div>
                </div>
                <div class="tippy-self_introduction"><%== gthread.user.self_introduction %></div>
                <div class="tippy-userbox-bottom">
                  <div class="tippy-user-communities-count">
                    <%= icon('fas', 'users') %> 所属コミュニティ数：
                    <span class="tippy-user-communities-count-number">
                      <%= gthread.user.communities.count %>
                    </span>
                  </div>
                  <div class="tippy-user-created_at">
                    <%= icon('far', 'calendar-alt') %>
                    <%= gthread.user.created_at.strftime("%-Y#{'年'}%-m#{'月'}") %>から利用しています
                  </div>
                </div>
              </div>`,
    allowHTML: true,
    arrow: false,
    placement: 'bottom-end',
    theme: 'light',
    delay: [600, 0],
    interactive: true
  });
  
  // リアクションしたユーザーとその人数
  <% gthread.thread_reactions.select(:images, :entity_name).distinct.each do |treaction| %>
    tippy('.treactions-list_<%= gthread.id %>_<%= treaction.entity_name %>', {
      content: `<div class="tippy-treaction-users-container">
                  <div class="tippy-treaction-images-box">
                    <img src='<%= "#{ treaction.images }" %>' class="tippy-treaction-images">
                  </div>
                  <div class="tippy-treaction-users-accountName">
                    <% gthread.thread_reaction_users.where(thread_reactions: { images: treaction.images }).each_with_index do |treaction_user, i| %>
                      <% if i == gthread.thread_reaction_users.where(thread_reactions: { images: treaction.images }).length - 1 %>
                        <%= treaction_user.accountName %>さんが
                        <span class="tippy-treaction-text-attached">リアクションしました</span>
                      <% else %>
                        <%= treaction_user.accountName %>さん,
                      <% end %>
                      <% if current_user.id == treaction_user.id %>
                        （削除する場合はクリック）
                      <% end %>
                    <% end %>
                  </div>
                </div>`,
      allowHTML: true,
      theme: 'treaction',
      delay: [200, 0],
    });
    
    // リアクション削除時確認ダイアログ(sweetalert2)
    $('#reaction-destroy-btn_<%= gthread.id %>_<%= treaction.entity_name %>').on('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      $('.treactions-list_<%= gthread.id %>_<%= treaction.entity_name %>').blur();
    
      var $link = $(this);
    
      swal.fire({
        icon: 'warning',
        iconColor: 'red',
        title: 'このリアクションを削除してもよろしいですか？',
        confirmButtonText: '削除する',
        confirmButtonColor: '#d33',
        showCancelButton: true,
        cancelButtonText: 'キャンセル',
        focusCancel: true,
        position : 'center',
        allowEscapeKey: true,
        customClass: {
          popup: 'sweetalert-reaction-destroy'
        }
      }).then(function(result) {
        if (result.isConfirmed) {
          $.ajax({
            url: '/thread_reactions/<%= treaction.entity_name %>',
            type: 'DELETE',
            data: { gthread_id: <%= gthread.id %> },
          });
        }
      }, function(dismiss) {});
    });
  <% end %>
  
  $('.image-preview<%= gthread.id %>').magnificPopup({
    delegate: 'a', // ポップアップを開く子要素
    type: 'image',
    gallery: {
      enabled: true,
      navigateByImgClick: true,
      preload: [0, 1]
    }
  });
  
  <% gthread.images.each do |files| %>
    tippy(`.thread-pdf-preview_<%= File.basename(files.url.gsub(/%/, ''), '.*') %>`, {
      content: `<%= File.basename(URI.decode(files.url.gsub(/%20|%5B|%22|%5D/, ''))) %>`,
      allowHTML: true,
      theme: 'black',
      delay: [100, 0],
    });
  <% end %>
  
  // スレッド削除時確認ダイアログ(sweetalert2)
  $('#thread-destroy-btn<%= gthread.id %>').on('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    // ダイアログを閉じてもボタンがフォーカス状態でtippyが動作してしまうため
    $('.thread-destroy-btn').blur();
  
    var $link = $(this);
  
    swal.fire({
      icon: "warning",
      iconColor: "red",
      title: '<%= gthread.title %> を削除してもよろしいですか？',
      text: "このスレッドのリアクション、コメントは全て削除されます。本当によろしいですか？",
      confirmButtonText: '削除する',
      confirmButtonColor: '#d33',
      showCancelButton: true,
      cancelButtonText: 'キャンセル',
      focusCancel: true,
      position : 'center',
      allowEscapeKey: true,
      customClass: {
        popup: 'sweetalert-thread-destroy'
      }
    }).then(function(result) {
      if (result.isConfirmed) {
        $link.trigger('click.rails');
      }
    }, function(dismiss) {})
  });
<% end %>

tippy('.treaction-btn', {
  content: 'リアクションする',
  theme: 'black',
  delay: [100, 0],
});
tippy('.treaction-number', {
  content: 'リアクションしたユーザー一覧',
  theme: 'black',
  delay: [100, 0],
});
tippy('.tcomment-btn', {
  content: 'コメントする',
  theme: 'black',
  delay: [100, 0],
});
tippy('.thread-destroy-btn', {
  content: '削除する',
  theme: 'black',
  delay: [100, 0],
});